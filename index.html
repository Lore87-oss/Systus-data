<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Webmap Systus – CSV live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body>

<h2 style="text-align:center;">Webmap Systus – CSV live</h2>
<div id="map"></div>

<script>
const map = L.map('map').setView([41.945, 12.42], 16);

// BASEMAP
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 22
}).addTo(map);

// =========================
// 1) CARICO AREE VERDI GEOJSON
// =========================
fetch("https://lore87-oss.github.io/Systus-data/Aree_verdi.geojson")
    .then(r => r.json())
    .then(geojson => {
        L.geoJSON(geojson, {
            style: {
                color: "green",
                weight: 2,
                fillColor: "lightgreen",
                fillOpacity: 0.4
            },
            onEachFeature: (f, layer) => {
                const nome = f.properties.Nome || "Area verde";
                const indirizzo = f.properties.Indirizzo || "";
                layer.bindPopup(`<b>${nome}</b><br>${indirizzo}`);
            }
        }).addTo(map);
    });

// =========================
// 2) CARICO CSV DEGLI ALBERI
// =========================

Papa.parse("https://lore87-oss.github.io/Systus-data/FB_Nuovo_Albero.csv", {
    download: true,
    header: true,
    complete: function(results) {
        results.data.forEach(row => {
            if (!row.CenterLat || !row.CenterLng) return;

            let lat = parseFloat(row.CenterLat);
            let lng = parseFloat(row.CenterLng);

            if (isNaN(lat) || isNaN(lng)) return;

            L.circleMarker([lat, lng], {
                radius: 6,
                color: "red",
                fillColor: "red",
                fillOpacity: 0.9
            })
            .bindPopup(`
                <b>Albero</b><br>
                Specie: ${row.Specie || "N/D"}<br>
                ID: ${row.ID || "N/D"}
            `)
            .addTo(map);
        });
    }
});
</script>

</body>
</html>
