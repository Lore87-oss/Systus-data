<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>Webmap Systus – CSV live</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  #map { height: 100vh; }
</style>

</head>
<body>
<h2 style="text-align:center;">Webmap Systus – CSV live</h2>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Libreria per convertire WKT ➜ GeoJSON -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wellknown/0.5.0/wellknown.min.js"></script>

<script>

// CREA MAPPA
var map = L.map("map").setView([41.90, 12.50], 12);

// BASEMAP
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 22
}).addTo(map);


/* ===========================
   1) CARICO AREE VERDI GEOJSON
=========================== */

fetch("https://lore87-oss.github.io/Systus-data/Aree_verdi.geojson")
    .then(r => r.json())
    .then(geojson => {
        L.geoJSON(geojson, {
            style: {
                color: "green",
                weight: 2,
                fillColor: "lightgreen",
                fillOpacity: 0.4
            },
            onEachFeature: (f, layer) => {
                const nome = f.properties.Nome || "Area verde";
                const indirizzo = f.properties.Indirizzo || "";
                layer.bindPopup(`<b>${nome}</b><br>${indirizzo}`);
            }
        }).addTo(map);
    });
/* ===========================
   2) CARICO ALBERI DA CSV
=========================== */

fetch("https://lore87-oss.github.io/Systus-data/FB_Nuovo_Albero.csv")
  .then(r => r.text())
  .then(text => {

    const rows = text.trim().split("\n");
    const header = rows[0].split(",");

    const idxLat = header.indexOf("LAT") >= 0 ? header.indexOf("LAT") : header.indexOf("lat");
    const idxLon = header.indexOf("LON") >= 0 ? header.indexOf("LON") : header.indexOf("lon");
    const idxSpecie = header.indexOf("SPECIE");
    const idxID = header.indexOf("OBJ_ID");

    for (let i = 1; i < rows.length; i++) {
      const cols = rows[i].split(",");

      const lat = parseFloat(cols[idxLat]);
      const lon = parseFloat(cols[idxLon]);

      if (!lat || !lon || isNaN(lat) || isNaN(lon)) continue;

      const specie = cols[idxSpecie] || "Specie non indicata";
      const objId = cols[idxID] || "ID non disponibile";

      L.circleMarker([lat, lon], {
        radius: 6,
        color: "blue",
        fillColor: "#00aaff",
        fillOpacity: 0.9
      })
      .bindPopup(`<b>Albero ${objId}</b><br>Specie: ${specie}`)
      .addTo(map);
    }

  });

</script>

</body>
</html>
