<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Webmap Systus – CSV + GeoJSON</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Libreria per leggere CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- Libreria per convertire WKT → GeoJSON -->
  <script src="https://unpkg.com/wellknown/wellknown.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { width:100%; height:100vh; }
    h1 { text-align:center; margin:15px; }
  </style>
</head>

<body>

<h1>Webmap Systus – CSV live</h1>
<div id="map"></div>

<script>
// ======================================================================
// 1) CREA LA MAPPA
// ======================================================================

var map = L.map("map").setView([41.90, 12.50], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);


// ======================================================================
// 2) CARICA ALBERI (CSV) – FUNZIONANTE COME PRIMA
// ======================================================================

Papa.parse("https://lore87-oss.github.io/Systus-data/FB_Nuovo_Albero.csv", {
  download: true,
  header: true,
  complete: function (results) {

    results.data.forEach(function (row) {

      if (!row.CenterLat || !row.CenterLng) return;

      var lat = parseFloat(row.CenterLat);
      var lng = parseFloat(row.CenterLng);

      if (isNaN(lat) || isNaN(lng)) return;

      L.circleMarker([lat, lng], {
        radius: 6,
        color: "red",
        fillColor: "red",
        fillOpacity: 0.8
      })
      .bindPopup(
        `<b>Albero</b><br>
         Specie: ${row.Specie || "N/D"}<br>
         ID: ${row.ID || "N/D"}`
      ).addTo(map);

    });

  }
});


// ======================================================================
// 3) CARICA AREE VERDI (GEOJSON) – NUOVO E PERFETTO
// ======================================================================

fetch("https://lore87-oss.github.io/Systus-data/Aree_verdi.geojson")
  .then(r => r.json())
  .then(geojson => {

    L.geoJSON(geojson, {
      style: {
        color: "green",
        fillColor: "lightgreen",
        weight: 2,
        fillOpacity: 0.30
      },
      onEachFeature: function (feature, layer) {
        const nome = feature.properties.Nome || "Area verde";
        const indirizzo = feature.properties.Indirizzo || "";
        layer.bindPopup(`<b>${nome}</b><br>${indirizzo}`);
      }
    }).addTo(map);

  })
  .catch(err => console.error("Errore nel caricamento del GeoJSON:", err));

</script>

</body>
</html>
